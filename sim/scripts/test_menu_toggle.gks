# Test menu toggle gesture behavior
# Verifies that:
# 1. Menu enter gesture (A hold + B hold) works
# 2. Button release does NOT exit menu (output stays stable)
# 3. Menu toggle gesture again exits menu
# 4. Output follows input correctly in gate mode after menu exit
#
# Note: Button B is the primary gate control, Button A is for menu

# Wait for app init
1000    log     Starting menu toggle test

# === Test 1: Enter menu with A+B hold gesture ===
0       log     Test 1: Entering menu with A hold + B hold gesture

# Press A first (this is the menu button)
0       press   a
20      assert  output low      # A is menu button, not gate - output stays low

# While holding A, press B (this will also turn on gate, but we're about to enter menu)
100     press   b

# Hold both past threshold (500ms for B to reach hold)
# A was pressed first, then B reaches threshold -> EVT_MENU_TOGGLE
550     log     Should now be in menu

# === Test 2: Release buttons - should NOT exit menu ===
0       log     Test 2: Releasing buttons (should stay in menu)

# Release A
50      release a
50      log     Button A released

# Release B - output was HIGH from B press, but now we're in menu so it should stay frozen
50      release b
# Note: Output state depends on timing - it was HIGH when B was pressed,
# and mode handler stops running in menu, so it stays at whatever state it was
50      log     Button B released

# === Test 3: Exit menu with A hold (solo) gesture ===
100     log     Test 3: Exiting menu with A hold gesture

# Hold A for 500ms to exit menu
0       press   a
550     release a
50      log     Should have exited menu

# === Test 4: Verify back in perform mode (gate mode active) ===
100     log     Test 4: Verifying gate mode is active again

# Button B should now control gate
0       press   b
20      assert  output high     # Gate mode: output follows Button B
100     release b
20      assert  output low

# Done
100     log     Menu toggle test complete
0       quit
